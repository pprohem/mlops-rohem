substitutions:
  _REGION: us-central1
  _MODEL_NAME: casas-model
  _PIPELINE_PACKAGE: mlops-pipelines==0.1.0
  _IMAGE_URI: ${_REGION}-docker.pkg.dev/$PROJECT_ID/mlops/${_MODEL_NAME}:${SHORT_SHA}

steps:
  # =====================================================
  # 1) Build da imagem de treino
  # =====================================================
  - id: build-training-image
    name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/mlops/${_MODEL_NAME}:${SHORT_SHA}
      - .

  # =====================================================
  # 2) Push da imagem
  # =====================================================
  - id: push-training-image
    name: gcr.io/cloud-builders/docker
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/mlops/${_MODEL_NAME}:${SHORT_SHA}
    waitFor: ["build-training-image"]

# =====================================================
# 3) Compile pipeline + submit no Vertex
# =====================================================
  - id: compile-and-submit-pipeline
    name: python:3.11
    entrypoint: bash
    args:
      - -c
      - |
        set -e

        # Instala tudo que esse step precisa
        python -m pip install --upgrade pip
        python -m pip install \
          --extra-index-url https://us-central1-python.pkg.dev/$PROJECT_ID/mlops-python/simple/ \
          mlops-pipelines==0.2.0 \
          google-cloud-aiplatform

        # Compila pipeline
        python - <<EOF
        from kfp.compiler import Compiler
        from mlops_pipelines.pipelines.training import training_pipeline

        Compiler().compile(
            pipeline_func=training_pipeline,
            package_path="pipeline.json",
        )
        EOF

        # Submete no Vertex
        python - <<EOF
        from google.cloud import aiplatform

        PROJECT_ID = "${PROJECT_ID}"
        REGION = "${_REGION}"
        MODEL_NAME = "${_MODEL_NAME}"
        IMAGE_URI = "${_IMAGE_URI}"
        DATASET_URI = "bq://${PROJECT_ID}.ml_rw.casas_rw"
        RUN_ID = "${SHORT_SHA}"
        ENVIRONMENT = "dev"

        PIPELINE_DISPLAY_NAME = f"train-{MODEL_NAME}-{RUN_ID}"

        aiplatform.init(
            project=PROJECT_ID,
            location=REGION,
        )

        job = aiplatform.PipelineJob(
            display_name=PIPELINE_DISPLAY_NAME,
            template_path="pipeline.json",
            parameter_values={
                "project_id": PROJECT_ID,
                "region": REGION,
                "model_name": MODEL_NAME,
                "image_uri": IMAGE_URI,
                "dataset_uri": DATASET_URI,
                "run_id": RUN_ID,
                "environment": ENVIRONMENT,
            },
        )

        # SubmissÃ£o assÃ­ncrona
        job.run(sync=False)

        # Logs SEM acessar resource_name
        print("")
        print("=================================================")
        print("ðŸš€ Pipeline submetida com sucesso ao Vertex AI")
        print("-------------------------------------------------")
        print(f"ðŸ“¦ Projeto:        {PROJECT_ID}")
        print(f"ðŸŒ RegiÃ£o:         {REGION}")
        print(f"ðŸ§  Modelo:         {MODEL_NAME}")
        print(f"ðŸ–¼ï¸  Image URI:     {IMAGE_URI}")
        print(f"ðŸ“Š Dataset URI:   {DATASET_URI}")
        print(f"ðŸ” Run ID:         {RUN_ID}")
        print(f"ðŸ·ï¸  Ambiente:      {ENVIRONMENT}")
        print("-------------------------------------------------")
        print("ðŸ”— Vertex UI (lista de execuÃ§Ãµes):")
        print(
            f"https://console.cloud.google.com/vertex-ai/locations/"
            f"{REGION}/pipelines?project={PROJECT_ID}"
        )
        print("â„¹ï¸  Procure pelo pipeline:")
        print(f"    {PIPELINE_DISPLAY_NAME}")
        print("-------------------------------------------------")
        print("â„¹ï¸  ExecuÃ§Ã£o ocorre de forma assÃ­ncrona no Vertex AI.")
        print("â„¹ï¸  Cloud Build finalizado com sucesso.")
        print("=================================================")
        print("")
        EOF

options:
  logging: CLOUD_LOGGING_ONLY
